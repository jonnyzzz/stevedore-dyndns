# Stevedore DynDNS Security Test Harness

Docker-based security testing for stevedore-dyndns deployments.

## Overview

This harness runs automated security tests against your deployed dyndns service to verify:

1. **Connectivity & DNS** - Basic reachability and DNS resolution
2. **HTTP Security Headers** - HSTS, CSP, X-Frame-Options, etc.
3. **Port Exposure** - Only expected ports are open
4. **TLS Configuration** - Protocol versions, cipher suites, certificate validity
5. **Cloudflare Proxy Mode** - mTLS verification, origin protection
6. **Web Vulnerabilities** - OWASP ZAP passive scanning
7. **Known Vulnerabilities** - Nuclei template checks
8. **Content Discovery** - Hidden paths and files

## Quick Start

```bash
# 1. Copy and configure .env
cp .env.example .env
# Edit .env with your target details

# 2. Run quick tests (connectivity, headers, ports, TLS, Cloudflare proxy)
./scripts/run_all.sh --quick --proxy

# 3. Run full test suite (includes ZAP, Nuclei)
./scripts/run_all.sh --proxy
```

## Configuration

Edit `.env` with your deployment details:

```bash
# Required
TARGET_HOST=app-home.example.com    # Your domain (for SNI)
TARGET_IP=203.0.113.10              # Your public IP (for port scans)
TARGET_URL=https://app-home.example.com

# For Cloudflare proxy mode tests
ORIGIN_IP=203.0.113.10              # Your actual origin IP
CLOUDFLARE_PROXY=true

# Optional: API checks (requires Zone Settings Read permission)
CLOUDFLARE_ZONE_ID=your_zone_id
CLOUDFLARE_API_TOKEN=your_token
```

## Test Scripts

| Script | Description | Safe for Prod |
|--------|-------------|---------------|
| `01_connectivity.sh` | DNS, routing, basic HTTP | Yes |
| `02_http_headers.sh` | Security headers analysis | Yes |
| `03_port_scan.sh` | nmap port scanning | Yes (passive) |
| `04_tls_audit.sh` | testssl.sh TLS analysis | Yes |
| `05_cloudflare_proxy.sh` | mTLS and proxy verification | Yes |
| `06_zap_baseline.sh` | OWASP ZAP passive scan | Yes |
| `07_nuclei.sh` | Template vulnerability checks | Mostly (rate-limited) |
| `08_feroxbuster.sh` | Content discovery | Aggressive - use caution |

## Cloudflare Proxy Mode Tests

The `05_cloudflare_proxy.sh` script specifically validates:

### Test 5.1: Proxy Active
Verifies traffic goes through Cloudflare by checking for `CF-Ray` header.

### Test 5.2: mTLS Origin Protection (CRITICAL)
Attempts direct HTTPS connection to origin IP. **Should fail with SSL error.**

If direct connection succeeds:
- Origin is exposed and attackers can bypass Cloudflare
- mTLS (Authenticated Origin Pull) is not working
- DDoS protection is ineffective

### Test 5.3: Connection via Cloudflare
Verifies normal HTTPS access works through Cloudflare.

### Test 5.4: API Configuration Check
If API token provided, verifies:
- SSL mode is "Full" or "Full (strict)"
- Authenticated Origin Pull is enabled

### Test 5.5: DNS Proxy Status
Confirms DNS resolves to Cloudflare IPs, not origin.

## Output

Reports are saved to `reports/<timestamp>/`:

```
reports/20260102_143012/
├── summary.json           # Machine-readable summary
├── report.html            # Human-readable HTML report
├── http_headers.txt       # Raw HTTP headers
├── header_findings.json   # Security header analysis
├── nmap_all_tcp.xml       # Full port scan results
├── testssl.html           # TLS audit report
├── cloudflare_proxy_findings.json  # Proxy mode test results
├── zap_baseline.html      # ZAP scan report
└── nuclei.jsonl           # Nuclei findings
```

## CI/CD Integration

The harness exits with code 1 if high/critical findings are detected:

```bash
# In CI pipeline
./scripts/run_all.sh --quick --proxy
if [ $? -ne 0 ]; then
    echo "Security tests failed!"
    exit 1
fi
```

## Vantage Points

**Important:** Run tests from outside your network for accurate results.

Running from the same network may miss:
- Firewall rules that affect external traffic
- CDN/WAF behavior
- NAT/routing issues

Recommended: Run from a cloud VM or CI runner.

## Required Docker Images

The harness uses these Docker images (pulled automatically):

- `nicolaka/netshoot` - Network troubleshooting
- `instrumentisto/nmap` - Port scanning
- `drwetter/testssl.sh` - TLS auditing
- `curlimages/curl` - HTTP testing
- `ghcr.io/zaproxy/zaproxy:stable` - Web scanning
- `projectdiscovery/nuclei` - Vulnerability checks
- `epi052/feroxbuster` - Content discovery

## Troubleshooting

### "Permission denied" on scripts
```bash
chmod +x scripts/*.sh
```

### "No route to host" errors
Check if your IP is correct and ports are forwarded.

### Cloudflare 5xx errors
- 520: Origin server error
- 521: Origin down
- 522: Connection timeout
- 523: Origin unreachable
- 525: SSL handshake failed (check SSL mode)
- 526: Invalid origin certificate

### mTLS test shows "unclear result"
Manually verify with:
```bash
curl -v --resolve "your.domain:443:ORIGIN_IP" https://your.domain
```

Expected: SSL/TLS handshake failure
Bad: HTTP response (origin exposed)

## Safety Notes

- Start with `--quick` flag for initial testing
- Content discovery (`08_feroxbuster.sh`) generates significant traffic
- Always test on staging first if available
- Have rollback plan for production tests
