#!/usr/bin/env bash
# Test 1: Connectivity and DNS sanity checks
set -euo pipefail

OUT="${1:?Usage: $0 <output_dir>}"
source "$(dirname "$0")/../.env"

echo "[1.1] DNS Resolution..."
docker run --rm nicolaka/netshoot dig +short "$TARGET_HOST" | tee "$OUT/dns_resolution.txt"

if [[ -s "$OUT/dns_resolution.txt" ]]; then
    echo "  OK: DNS resolves"
else
    echo "  FAIL: DNS does not resolve"
fi

echo ""
echo "[1.2] IPv6 Resolution (if applicable)..."
docker run --rm nicolaka/netshoot dig +short AAAA "$TARGET_HOST" | tee "$OUT/dns_aaaa.txt" || true

echo ""
echo "[1.3] Basic connectivity test..."
if docker run --rm curlimages/curl -sS -o /dev/null -w "%{http_code}" --max-time 10 "$TARGET_URL" > "$OUT/http_code.txt" 2>&1; then
    HTTP_CODE=$(cat "$OUT/http_code.txt")
    echo "  HTTP Status: $HTTP_CODE"
    if [[ "$HTTP_CODE" == "200" ]] || [[ "$HTTP_CODE" == "301" ]] || [[ "$HTTP_CODE" == "302" ]]; then
        echo "  OK: Site is reachable"
    else
        echo "  WARN: Unexpected HTTP status code"
    fi
else
    echo "  FAIL: Could not connect to target"
fi

echo ""
echo "[1.4] Traceroute (first 10 hops)..."
docker run --rm nicolaka/netshoot traceroute -m 10 "$TARGET_HOST" 2>&1 | tee "$OUT/traceroute.txt" || true
