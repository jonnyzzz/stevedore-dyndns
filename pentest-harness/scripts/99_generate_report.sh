#!/usr/bin/env bash
# Generate final summary report from all test results
set -euo pipefail

OUT="${1:?Usage: $0 <output_dir>}"
source "$(dirname "$0")/../.env"

SUMMARY="$OUT/summary.json"

echo "Generating final report..."

# Ensure summary exists
if [[ ! -f "$SUMMARY" ]]; then
    cat > "$SUMMARY" << EOF
{
  "target": {"host": "$TARGET_HOST", "ip": "$TARGET_IP", "url": "$TARGET_URL"},
  "timestamp": "$(date -Iseconds)",
  "findings": [],
  "artifacts": {}
}
EOF
fi

# Collect all findings from individual test results

# Header findings
if [[ -f "$OUT/header_findings.json" ]]; then
    HEADER_FINDINGS=$(jq -c '.findings[]' "$OUT/header_findings.json" 2>/dev/null || echo "")
    if [[ -n "$HEADER_FINDINGS" ]]; then
        while IFS= read -r finding; do
            HEADER=$(echo "$finding" | jq -r '.header')
            SEV=$(echo "$finding" | jq -r '.severity')
            DESC=$(echo "$finding" | jq -r '.description')
            tmp=$(mktemp)
            jq --arg t "headers" --arg s "$SEV" --arg ti "Missing $HEADER header" --arg e "$DESC" \
               '.findings += [{"tool": $t, "severity": $s, "title": $ti, "evidence": $e}]' \
               "$SUMMARY" > "$tmp" && mv "$tmp" "$SUMMARY"
        done <<< "$HEADER_FINDINGS"
    fi
fi

# Port findings
if [[ -f "$OUT/port_findings.json" ]]; then
    UNEXPECTED=$(jq -r '.unexpected_ports // ""' "$OUT/port_findings.json" 2>/dev/null)
    if [[ -n "$UNEXPECTED" ]] && [[ "$UNEXPECTED" != "null" ]]; then
        tmp=$(mktemp)
        jq --arg ports "$UNEXPECTED" \
           '.findings += [{"tool": "nmap", "severity": "high", "title": "Unexpected open ports", "evidence": $ports}]' \
           "$SUMMARY" > "$tmp" && mv "$tmp" "$SUMMARY"
    fi
fi

# Cloudflare proxy findings
if [[ -f "$OUT/cloudflare_proxy_findings.json" ]]; then
    CF_FINDINGS=$(jq -c '.tests[] | select(.status != "pass")' "$OUT/cloudflare_proxy_findings.json" 2>/dev/null || echo "")
    if [[ -n "$CF_FINDINGS" ]]; then
        while IFS= read -r finding; do
            NAME=$(echo "$finding" | jq -r '.name')
            SEV=$(echo "$finding" | jq -r '.severity')
            DET=$(echo "$finding" | jq -r '.details')
            tmp=$(mktemp)
            jq --arg t "cloudflare_proxy" --arg s "$SEV" --arg ti "$NAME" --arg e "$DET" \
               '.findings += [{"tool": $t, "severity": $s, "title": $ti, "evidence": $e}]' \
               "$SUMMARY" > "$tmp" && mv "$tmp" "$SUMMARY"
        done <<< "$CF_FINDINGS"
    fi
fi

# Add artifact references
for artifact in nmap_all_tcp.xml testssl.html testssl.json zap_baseline.html zap_baseline.json nuclei.jsonl ferox.txt; do
    if [[ -f "$OUT/$artifact" ]]; then
        NAME=$(echo "$artifact" | tr '.' '_')
        tmp=$(mktemp)
        jq --arg name "$NAME" --arg path "$OUT/$artifact" \
           '.artifacts[$name] = $path' \
           "$SUMMARY" > "$tmp" && mv "$tmp" "$SUMMARY"
    fi
done

# Generate HTML report
cat > "$OUT/report.html" << 'HTMLEOF'
<!DOCTYPE html>
<html>
<head>
    <title>Security Test Report</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 40px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #333; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
        h2 { color: #555; margin-top: 30px; }
        .target-info { background: #e9ecef; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
        .finding { margin: 10px 0; padding: 15px; border-radius: 5px; border-left: 4px solid; }
        .critical { background: #f8d7da; border-color: #721c24; }
        .high { background: #fff3cd; border-color: #856404; }
        .medium { background: #d1ecf1; border-color: #0c5460; }
        .low { background: #d4edda; border-color: #155724; }
        .info, .ok { background: #e2e3e5; border-color: #383d41; }
        .severity-badge { display: inline-block; padding: 3px 8px; border-radius: 3px; font-size: 12px; font-weight: bold; text-transform: uppercase; margin-right: 10px; }
        .severity-badge.critical { background: #721c24; color: white; }
        .severity-badge.high { background: #856404; color: white; }
        .severity-badge.medium { background: #0c5460; color: white; }
        .severity-badge.low { background: #155724; color: white; }
        .artifacts { margin-top: 30px; }
        .artifact-list { list-style: none; padding: 0; }
        .artifact-list li { padding: 8px 0; border-bottom: 1px solid #eee; }
        .summary-box { display: flex; gap: 20px; margin-bottom: 30px; }
        .summary-item { flex: 1; padding: 20px; border-radius: 8px; text-align: center; }
        .summary-item.critical-bg { background: #f8d7da; }
        .summary-item.high-bg { background: #fff3cd; }
        .summary-item.pass-bg { background: #d4edda; }
        .summary-item h3 { margin: 0 0 10px 0; font-size: 14px; text-transform: uppercase; }
        .summary-item .count { font-size: 36px; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Security Test Report</h1>
        <div id="content">Loading...</div>
    </div>
    <script>
HTMLEOF

# Embed the JSON data
echo "const data = " >> "$OUT/report.html"
cat "$SUMMARY" >> "$OUT/report.html"

cat >> "$OUT/report.html" << 'HTMLEOF'
;
        const content = document.getElementById('content');

        // Count findings by severity
        const counts = {critical: 0, high: 0, medium: 0, low: 0};
        data.findings.forEach(f => {
            if (counts[f.severity] !== undefined) counts[f.severity]++;
        });

        let html = `
            <div class="target-info">
                <strong>Target:</strong> ${data.target.url}<br>
                <strong>Host:</strong> ${data.target.host}<br>
                <strong>IP:</strong> ${data.target.ip}<br>
                <strong>Timestamp:</strong> ${data.timestamp}
            </div>

            <div class="summary-box">
                <div class="summary-item critical-bg">
                    <h3>Critical</h3>
                    <div class="count">${counts.critical}</div>
                </div>
                <div class="summary-item high-bg">
                    <h3>High</h3>
                    <div class="count">${counts.high}</div>
                </div>
                <div class="summary-item pass-bg">
                    <h3>Medium/Low</h3>
                    <div class="count">${counts.medium + counts.low}</div>
                </div>
            </div>

            <h2>Findings</h2>
        `;

        if (data.findings.length === 0) {
            html += '<p>No significant findings detected.</p>';
        } else {
            // Sort by severity
            const severityOrder = {critical: 0, high: 1, medium: 2, low: 3, info: 4, ok: 5};
            data.findings.sort((a, b) => (severityOrder[a.severity] || 99) - (severityOrder[b.severity] || 99));

            data.findings.forEach(f => {
                html += `
                    <div class="finding ${f.severity}">
                        <span class="severity-badge ${f.severity}">${f.severity}</span>
                        <strong>${f.title}</strong>
                        <br><small>Tool: ${f.tool}</small>
                        ${f.evidence ? `<br><code>${f.evidence}</code>` : ''}
                    </div>
                `;
            });
        }

        html += '<h2>Artifacts</h2><ul class="artifact-list">';
        Object.entries(data.artifacts).forEach(([name, path]) => {
            html += `<li><strong>${name}:</strong> ${path}</li>`;
        });
        html += '</ul>';

        content.innerHTML = html;
    </script>
</body>
</html>
HTMLEOF

echo ""
echo "Report generated: $OUT/report.html"

# Print summary
echo ""
echo "=============================================="
echo "SECURITY TEST SUMMARY"
echo "=============================================="

CRITICAL=$(jq '[.findings[] | select(.severity == "critical")] | length' "$SUMMARY")
HIGH=$(jq '[.findings[] | select(.severity == "high")] | length' "$SUMMARY")
MEDIUM=$(jq '[.findings[] | select(.severity == "medium")] | length' "$SUMMARY")
LOW=$(jq '[.findings[] | select(.severity == "low")] | length' "$SUMMARY")

echo "Critical: $CRITICAL"
echo "High:     $HIGH"
echo "Medium:   $MEDIUM"
echo "Low:      $LOW"
echo ""

if [[ "$CRITICAL" -gt 0 ]]; then
    echo "CRITICAL FINDINGS:"
    jq -r '.findings[] | select(.severity == "critical") | "  - \(.title): \(.evidence)"' "$SUMMARY"
    echo ""
fi

if [[ "$HIGH" -gt 0 ]]; then
    echo "HIGH SEVERITY FINDINGS:"
    jq -r '.findings[] | select(.severity == "high") | "  - \(.title): \(.evidence)"' "$SUMMARY"
    echo ""
fi

echo "=============================================="
