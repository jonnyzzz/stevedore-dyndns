# Stevedore DynDNS - Docker Compose for Stevedore Deployment
#
# Deploy with: stevedore repo add dyndns <git-url>
#              stevedore deploy sync dyndns
#              stevedore deploy up dyndns
#
# Configure secrets with:
#   stevedore param set dyndns CLOUDFLARE_API_TOKEN "your-token"
#   stevedore param set dyndns CLOUDFLARE_ZONE_ID "your-zone-id"
#   stevedore param set dyndns DOMAIN "example.com"
#   stevedore param set dyndns ACME_EMAIL "admin@example.com"

services:
  dyndns:
    build: .
    image: stevedore-dyndns:latest
    restart: unless-stopped

    # Ports for HTTPS reverse proxy
    # Note: When using network_mode: host, ports are ignored
    ports:
      - "80:80"       # HTTP (redirect to HTTPS)
      - "443:443"     # HTTPS
      - "443:443/udp" # HTTP/3 (QUIC)
      - "8080:8080"   # Health/status endpoint (internal)

    environment:
      # Stevedore-provided variables
      - STEVEDORE_DEPLOYMENT=${STEVEDORE_DEPLOYMENT:-dyndns}

      # Required - set via: stevedore param set dyndns <KEY> <value>
      # Note: Use pass-through syntax for stevedore compatibility
      - CLOUDFLARE_API_TOKEN
      - CLOUDFLARE_ZONE_ID
      - DOMAIN
      - ACME_EMAIL

      # Optional - Fritzbox configuration (works without auth on most routers)
      - FRITZBOX_HOST=${FRITZBOX_HOST:-192.168.178.1}
      - FRITZBOX_USER=${FRITZBOX_USER:-}
      - FRITZBOX_PASSWORD=${FRITZBOX_PASSWORD:-}

      # Optional - Manual IP override (disables auto-detection)
      - MANUAL_IPV4=${MANUAL_IPV4:-}
      - MANUAL_IPV6=${MANUAL_IPV6:-}

      # Optional - Tuning
      - IP_CHECK_INTERVAL=${IP_CHECK_INTERVAL:-5m}
      - LOG_LEVEL=${LOG_LEVEL:-info}

      # Internal paths (set by Stevedore or use defaults for local dev)
      - DYNDNS_DATA=${STEVEDORE_DATA:-./data}
      - DYNDNS_LOGS=${STEVEDORE_LOGS:-./logs}

    volumes:
      # Persistent data - certificates, DNS state
      # Stevedore provides: /opt/stevedore/deployments/dyndns/data
      - ${STEVEDORE_DATA:-./data}:/data

      # Logs directory
      # Stevedore provides: /opt/stevedore/deployments/dyndns/logs
      - ${STEVEDORE_LOGS:-./logs}:/var/log/dyndns

      # Shared storage for cross-deployment communication
      # Other deployments can register themselves here
      # Stevedore provides: /opt/stevedore/shared
      - ${STEVEDORE_SHARED:-./shared}:/shared

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

    # Security hardening
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE  # Required for binding to ports 80/443

    # Network mode options:
    #
    # Option 1: Host network (RECOMMENDED for Fritzbox auto-detection)
    # - Required for TR-064/UPnP IP detection from local router
    # - All ports directly exposed on host (ports: section ignored)
    # - Simple setup, works out of the box
    network_mode: host

    # Option 2: Bridge network (use with MANUAL_IPV4/MANUAL_IPV6)
    # Uncomment below and comment out network_mode: host
    # networks:
    #   - default

    # labels for potential future service discovery
    labels:
      - "stevedore.dyndns.enabled=true"
      - "stevedore.dyndns.role=ingress"

# Network for bridge mode (uncomment if not using host network)
# networks:
#   default:
#     name: stevedore-dyndns
