#!/usr/bin/env bash
# Test 3: Port Scanning
set -euo pipefail

OUT="${1:?Usage: $0 <output_dir>}"
source "$(dirname "$0")/../.env"

EXPECTED_PORTS="${EXPECTED_PORTS:-80,443}"

echo "[3.1] Scanning expected ports ($EXPECTED_PORTS)..."
docker run --rm -v "$OUT:/data" instrumentisto/nmap \
    -sT -Pn -p "$EXPECTED_PORTS" \
    --reason --open \
    -oA /data/nmap_expected \
    "$TARGET_IP" 2>&1 | tee "$OUT/nmap_expected_output.txt"

echo ""
echo "[3.2] Full TCP port scan (this may take a while)..."
# Use -T4 for faster scanning, but still reasonable
docker run --rm -v "$OUT:/data" instrumentisto/nmap \
    -sT -Pn -p- \
    -T4 \
    --reason --open \
    --max-retries 2 \
    -oA /data/nmap_all_tcp \
    "$TARGET_IP" 2>&1 | tee "$OUT/nmap_all_tcp_output.txt"

echo ""
echo "[3.3] Analyzing open ports..."

# Parse nmap XML output for open ports
if [[ -f "$OUT/nmap_all_tcp.xml" ]]; then
    # Extract open ports from XML
    OPEN_PORTS=$(grep -oP 'portid="\K[0-9]+' "$OUT/nmap_all_tcp.xml" 2>/dev/null | sort -n | uniq | tr '\n' ',' | sed 's/,$//')

    if [[ -n "$OPEN_PORTS" ]]; then
        echo "  Open ports found: $OPEN_PORTS"

        # Compare with expected
        IFS=',' read -ra EXPECTED_ARR <<< "$EXPECTED_PORTS"
        IFS=',' read -ra OPEN_ARR <<< "$OPEN_PORTS"

        UNEXPECTED=""
        for port in "${OPEN_ARR[@]}"; do
            FOUND=false
            for expected in "${EXPECTED_ARR[@]}"; do
                if [[ "$port" == "$expected" ]]; then
                    FOUND=true
                    break
                fi
            done
            if [[ "$FOUND" == "false" ]]; then
                UNEXPECTED="$UNEXPECTED $port"
            fi
        done

        if [[ -n "$UNEXPECTED" ]]; then
            echo ""
            echo "  [HIGH] UNEXPECTED OPEN PORTS:$UNEXPECTED"
            echo "  These ports should be reviewed and potentially closed."

            # Save to findings
            cat > "$OUT/port_findings.json" << EOF
{
  "expected_ports": "$EXPECTED_PORTS",
  "open_ports": "$OPEN_PORTS",
  "unexpected_ports": "${UNEXPECTED# }",
  "severity": "high",
  "recommendation": "Review and close unexpected ports"
}
EOF
        else
            echo "  [OK] All open ports are expected"
            cat > "$OUT/port_findings.json" << EOF
{
  "expected_ports": "$EXPECTED_PORTS",
  "open_ports": "$OPEN_PORTS",
  "unexpected_ports": null,
  "severity": "ok"
}
EOF
        fi
    else
        echo "  [INFO] No open ports detected (might be filtered)"
    fi
else
    echo "  [WARN] Could not parse nmap XML output"
fi

echo ""
echo "[3.4] Service version detection on open ports..."
if [[ -n "${OPEN_PORTS:-}" ]]; then
    docker run --rm -v "$OUT:/data" instrumentisto/nmap \
        -sV -sT -Pn -p "$OPEN_PORTS" \
        -oA /data/nmap_versions \
        "$TARGET_IP" 2>&1 | tee "$OUT/nmap_versions_output.txt"
fi

echo ""
echo "Port scan complete."
