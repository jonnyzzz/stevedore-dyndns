#!/usr/bin/env bash
# Test 8: Content Discovery with feroxbuster
# NOTE: This is an aggressive scan - use with caution
set -euo pipefail

OUT="${1:?Usage: $0 <output_dir>}"
source "$(dirname "$0")/../.env"

echo "[8.1] Running feroxbuster content discovery..."
echo "      WARNING: This generates significant traffic"
echo ""

# Run with conservative settings
docker run --rm -v "$OUT:/data" epi052/feroxbuster \
    -u "$TARGET_URL" \
    -x html,js,json,txt \
    -t 5 \
    -d 2 \
    --rate-limit 10 \
    -o /data/ferox.txt \
    2>&1 | tee "$OUT/ferox_output.txt" || true

echo ""
echo "[8.2] Analyzing discovered paths..."

if [[ -f "$OUT/ferox.txt" ]] && [[ -s "$OUT/ferox.txt" ]]; then
    # Look for potentially sensitive paths
    echo "  Checking for sensitive paths..."

    SENSITIVE_PATTERNS=("\.git" "\.env" "admin" "backup" "config" "debug" "swagger" "actuator" "phpinfo" "\.htaccess" "wp-admin" "\.DS_Store")

    for pattern in "${SENSITIVE_PATTERNS[@]}"; do
        if grep -qi "$pattern" "$OUT/ferox.txt" 2>/dev/null; then
            echo "  [WARN] Potentially sensitive path found matching: $pattern"
            grep -i "$pattern" "$OUT/ferox.txt" | head -3 | sed 's/^/         /'
        fi
    done

    TOTAL_FOUND=$(wc -l < "$OUT/ferox.txt")
    echo ""
    echo "  Total paths discovered: $TOTAL_FOUND"
else
    echo "  No significant paths discovered"
fi

echo ""
echo "Content discovery complete."
