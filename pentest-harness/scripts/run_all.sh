#!/usr/bin/env bash
# Stevedore DynDNS Security Test Harness
# Run all security tests and generate reports
#
# Usage: ./scripts/run_all.sh [options]
#   --quick     Run only quick tests (skip full scans)
#   --proxy     Run Cloudflare proxy mode specific tests
#   --help      Show this help

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
HARNESS_DIR="$(dirname "$SCRIPT_DIR")"

# Load environment
if [[ -f "$HARNESS_DIR/.env" ]]; then
    source "$HARNESS_DIR/.env"
else
    echo "ERROR: .env file not found. Copy .env.example to .env and configure it."
    exit 1
fi

# Parse arguments
QUICK_MODE=false
PROXY_MODE=false

while [[ $# -gt 0 ]]; do
    case $1 in
        --quick)
            QUICK_MODE=true
            shift
            ;;
        --proxy)
            PROXY_MODE=true
            shift
            ;;
        --help)
            head -10 "$0" | tail -8
            exit 0
            ;;
        *)
            echo "Unknown option: $1"
            exit 1
            ;;
    esac
done

# Create timestamped output directory
TS="$(date +%Y%m%d_%H%M%S)"
OUT="$HARNESS_DIR/reports/$TS"
mkdir -p "$OUT"

echo "=============================================="
echo "Stevedore DynDNS Security Test Harness"
echo "=============================================="
echo "Target Host: $TARGET_HOST"
echo "Target IP:   $TARGET_IP"
echo "Target URL:  $TARGET_URL"
echo "Output Dir:  $OUT"
echo "Quick Mode:  $QUICK_MODE"
echo "Proxy Mode:  $PROXY_MODE"
echo "=============================================="
echo ""

# Initialize summary
SUMMARY_FILE="$OUT/summary.json"
cat > "$SUMMARY_FILE" << EOF
{
  "target": {
    "host": "$TARGET_HOST",
    "ip": "$TARGET_IP",
    "url": "$TARGET_URL"
  },
  "timestamp": "$TS",
  "mode": {
    "quick": $QUICK_MODE,
    "cloudflare_proxy": ${CLOUDFLARE_PROXY:-false}
  },
  "findings": [],
  "artifacts": {}
}
EOF

# Helper function to add findings
add_finding() {
    local tool="$1"
    local severity="$2"
    local title="$3"
    local evidence="${4:-}"

    local tmp=$(mktemp)
    jq --arg tool "$tool" \
       --arg sev "$severity" \
       --arg title "$title" \
       --arg ev "$evidence" \
       '.findings += [{"tool": $tool, "severity": $sev, "title": $title, "evidence": $ev}]' \
       "$SUMMARY_FILE" > "$tmp" && mv "$tmp" "$SUMMARY_FILE"
}

# Helper function to add artifacts
add_artifact() {
    local name="$1"
    local path="$2"

    local tmp=$(mktemp)
    jq --arg name "$name" --arg path "$path" \
       '.artifacts[$name] = $path' \
       "$SUMMARY_FILE" > "$tmp" && mv "$tmp" "$SUMMARY_FILE"
}

echo "=== Step 1: Connectivity & DNS Sanity ==="
"$SCRIPT_DIR/01_connectivity.sh" "$OUT" || true

echo ""
echo "=== Step 2: HTTP Headers & Security ==="
"$SCRIPT_DIR/02_http_headers.sh" "$OUT" || true

echo ""
echo "=== Step 3: Port Scanning ==="
"$SCRIPT_DIR/03_port_scan.sh" "$OUT" || true

echo ""
echo "=== Step 4: TLS/SSL Configuration ==="
"$SCRIPT_DIR/04_tls_audit.sh" "$OUT" || true

if [[ "$PROXY_MODE" == "true" ]] || [[ "${CLOUDFLARE_PROXY:-false}" == "true" ]]; then
    echo ""
    echo "=== Step 5: Cloudflare Proxy Mode Tests ==="
    "$SCRIPT_DIR/05_cloudflare_proxy.sh" "$OUT" || true
fi

if [[ "$QUICK_MODE" != "true" ]]; then
    echo ""
    echo "=== Step 6: Web Application Scan (ZAP Baseline) ==="
    "$SCRIPT_DIR/06_zap_baseline.sh" "$OUT" || true

    echo ""
    echo "=== Step 7: Nuclei Template Checks ==="
    "$SCRIPT_DIR/07_nuclei.sh" "$OUT" || true
fi

if [[ "$QUICK_MODE" != "true" ]] && [[ "${SKIP_AGGRESSIVE:-true}" != "true" ]]; then
    echo ""
    echo "=== Step 8: Content Discovery (feroxbuster) ==="
    "$SCRIPT_DIR/08_feroxbuster.sh" "$OUT" || true
fi

echo ""
echo "=== Generating Final Report ==="
"$SCRIPT_DIR/99_generate_report.sh" "$OUT"

echo ""
echo "=============================================="
echo "Security tests completed!"
echo "Reports saved to: $OUT"
echo ""
echo "Key files:"
echo "  - Summary:    $OUT/summary.json"
echo "  - Full HTML:  $OUT/report.html (if generated)"
echo "=============================================="

# Exit with error if high severity findings
HIGH_COUNT=$(jq '[.findings[] | select(.severity == "high" or .severity == "critical")] | length' "$SUMMARY_FILE")
if [[ "$HIGH_COUNT" -gt 0 ]]; then
    echo ""
    echo "WARNING: $HIGH_COUNT high/critical severity finding(s) detected!"
    exit 1
fi
