#!/usr/bin/env bash
# Test 4: TLS/SSL Configuration Audit
set -euo pipefail

OUT="${1:?Usage: $0 <output_dir>}"
source "$(dirname "$0")/../.env"

echo "[4.1] Running testssl.sh audit..."
echo "  This may take several minutes..."

docker run --rm -v "$OUT:/data" drwetter/testssl.sh \
    --jsonfile /data/testssl.json \
    --htmlfile /data/testssl.html \
    --severity HIGH \
    --quiet \
    "$TARGET_HOST:443" 2>&1 | tee "$OUT/testssl_output.txt" || true

echo ""
echo "[4.2] Analyzing TLS configuration..."

if [[ -f "$OUT/testssl.json" ]]; then
    # Parse critical findings
    echo "  Checking for critical issues..."

    # Check for deprecated protocols
    if grep -q '"TLS 1.0"' "$OUT/testssl.json" 2>/dev/null; then
        echo "  [HIGH] TLS 1.0 is enabled (deprecated)"
    fi
    if grep -q '"TLS 1.1"' "$OUT/testssl.json" 2>/dev/null; then
        echo "  [HIGH] TLS 1.1 is enabled (deprecated)"
    fi
    if grep -q '"SSLv3"' "$OUT/testssl.json" 2>/dev/null; then
        echo "  [CRITICAL] SSLv3 is enabled (insecure!)"
    fi

    # Check for weak ciphers
    if grep -qi '"severity" *: *"HIGH"' "$OUT/testssl.json" 2>/dev/null; then
        echo "  [HIGH] High severity TLS issues detected - see testssl.html for details"
    elif grep -qi '"severity" *: *"MEDIUM"' "$OUT/testssl.json" 2>/dev/null; then
        echo "  [MEDIUM] Medium severity TLS issues detected - see testssl.html for details"
    else
        echo "  [OK] No critical TLS issues detected"
    fi

    # Check certificate validity
    if grep -qi '"cert_trust" *:.*"not valid"' "$OUT/testssl.json" 2>/dev/null; then
        echo "  [HIGH] Certificate trust issue detected"
    fi

    if grep -qi '"cert_expirationStatus".*"expired"' "$OUT/testssl.json" 2>/dev/null; then
        echo "  [CRITICAL] Certificate is EXPIRED"
    fi
else
    echo "  [WARN] testssl.json not generated, manual review needed"
fi

echo ""
echo "[4.3] Quick certificate check with openssl..."
echo | openssl s_client -connect "$TARGET_HOST:443" -servername "$TARGET_HOST" 2>/dev/null | \
    openssl x509 -noout -dates -subject -issuer 2>/dev/null | tee "$OUT/cert_info.txt" || true

if [[ -s "$OUT/cert_info.txt" ]]; then
    echo ""
    echo "  Certificate details:"
    cat "$OUT/cert_info.txt" | sed 's/^/    /'

    # Check expiry
    NOT_AFTER=$(grep "notAfter" "$OUT/cert_info.txt" | cut -d= -f2)
    if [[ -n "$NOT_AFTER" ]]; then
        EXPIRY_EPOCH=$(date -d "$NOT_AFTER" +%s 2>/dev/null || date -j -f "%b %d %T %Y %Z" "$NOT_AFTER" +%s 2>/dev/null || echo "0")
        NOW_EPOCH=$(date +%s)
        DAYS_LEFT=$(( (EXPIRY_EPOCH - NOW_EPOCH) / 86400 ))

        echo ""
        if [[ $DAYS_LEFT -lt 0 ]]; then
            echo "  [CRITICAL] Certificate EXPIRED $((DAYS_LEFT * -1)) days ago!"
        elif [[ $DAYS_LEFT -lt 7 ]]; then
            echo "  [HIGH] Certificate expires in $DAYS_LEFT days!"
        elif [[ $DAYS_LEFT -lt 30 ]]; then
            echo "  [MEDIUM] Certificate expires in $DAYS_LEFT days"
        else
            echo "  [OK] Certificate valid for $DAYS_LEFT days"
        fi
    fi
fi

echo ""
echo "TLS audit complete."
