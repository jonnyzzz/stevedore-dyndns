#!/usr/bin/env bash
# Test 6: OWASP ZAP Baseline Scan
set -euo pipefail

OUT="${1:?Usage: $0 <output_dir>}"
source "$(dirname "$0")/../.env"

echo "[6.1] Running OWASP ZAP Baseline Scan..."
echo "      This performs passive scanning (safe for production)"
echo ""

# ZAP baseline scan - passive only, safe for production
docker run --rm -v "$OUT:/zap/wrk:rw" -t ghcr.io/zaproxy/zaproxy:stable \
    zap-baseline.py \
    -t "$TARGET_URL" \
    -r zap_baseline.html \
    -J zap_baseline.json \
    -I 2>&1 | tee "$OUT/zap_output.txt" || true

echo ""
echo "[6.2] Analyzing ZAP results..."

if [[ -f "$OUT/zap_baseline.json" ]]; then
    # Count alerts by risk level
    HIGH=$(jq '[.site[].alerts[] | select(.riskcode == "3")] | length' "$OUT/zap_baseline.json" 2>/dev/null || echo "0")
    MEDIUM=$(jq '[.site[].alerts[] | select(.riskcode == "2")] | length' "$OUT/zap_baseline.json" 2>/dev/null || echo "0")
    LOW=$(jq '[.site[].alerts[] | select(.riskcode == "1")] | length' "$OUT/zap_baseline.json" 2>/dev/null || echo "0")
    INFO=$(jq '[.site[].alerts[] | select(.riskcode == "0")] | length' "$OUT/zap_baseline.json" 2>/dev/null || echo "0")

    echo ""
    echo "  ZAP Findings Summary:"
    echo "    High:        $HIGH"
    echo "    Medium:      $MEDIUM"
    echo "    Low:         $LOW"
    echo "    Informational: $INFO"

    if [[ "$HIGH" -gt 0 ]]; then
        echo ""
        echo "  [HIGH] High severity findings detected!"
        echo "  Review $OUT/zap_baseline.html for details"
    fi
else
    echo "  [WARN] ZAP results not found"
fi

echo ""
echo "ZAP baseline scan complete."
