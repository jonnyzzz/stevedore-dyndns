#!/usr/bin/env bash
# Test 5: Cloudflare Proxy Mode Security Tests
# These tests verify that:
# 1. mTLS (Authenticated Origin Pull) is working
# 2. Direct connections to origin are rejected
# 3. Cloudflare settings are properly configured
set -euo pipefail

OUT="${1:?Usage: $0 <output_dir>}"
source "$(dirname "$0")/../.env"

# Required for proxy mode tests
ORIGIN_IP="${ORIGIN_IP:-$TARGET_IP}"

echo "=============================================="
echo "Cloudflare Proxy Mode Security Tests"
echo "=============================================="
echo "Target (via Cloudflare): $TARGET_URL"
echo "Origin IP (direct):      $ORIGIN_IP"
echo "=============================================="
echo ""

# Initialize results
cat > "$OUT/cloudflare_proxy_findings.json" << EOF
{
  "test_suite": "cloudflare_proxy_mode",
  "timestamp": "$(date -Iseconds)",
  "tests": []
}
EOF

add_test_result() {
    local name="$1"
    local status="$2"
    local severity="$3"
    local details="$4"

    local tmp=$(mktemp)
    jq --arg name "$name" \
       --arg status "$status" \
       --arg sev "$severity" \
       --arg det "$details" \
       '.tests += [{"name": $name, "status": $status, "severity": $sev, "details": $det}]' \
       "$OUT/cloudflare_proxy_findings.json" > "$tmp" && mv "$tmp" "$OUT/cloudflare_proxy_findings.json"
}

echo "=== Test 5.1: Verify traffic is proxied through Cloudflare ==="
echo ""

# Check if response headers indicate Cloudflare
CF_HEADERS=$(docker run --rm curlimages/curl -sS -D - -o /dev/null "$TARGET_URL" 2>/dev/null || true)
echo "$CF_HEADERS" > "$OUT/cloudflare_headers.txt"

if echo "$CF_HEADERS" | grep -qi "cf-ray:"; then
    CF_RAY=$(echo "$CF_HEADERS" | grep -i "cf-ray:" | head -1)
    echo "[OK] Traffic is proxied through Cloudflare"
    echo "     $CF_RAY"
    add_test_result "cloudflare_proxy_active" "pass" "ok" "CF-Ray header present: $CF_RAY"
else
    echo "[FAIL] Traffic does NOT appear to be proxied through Cloudflare!"
    echo "       Missing CF-Ray header. DNS may be set to grey cloud (DNS only)."
    add_test_result "cloudflare_proxy_active" "fail" "high" "CF-Ray header missing - proxy not active"
fi

echo ""
echo "=== Test 5.2: mTLS - Direct connection to origin should FAIL ==="
echo ""
echo "Attempting direct HTTPS connection to origin IP ($ORIGIN_IP)..."
echo "This should fail with SSL/TLS error if mTLS is properly configured."
echo ""

# Try connecting directly to the origin IP
# We use --resolve to force the connection to go to the origin IP
# but still send the correct SNI
DIRECT_RESULT=$(docker run --rm curlimages/curl -sS -v \
    --resolve "$TARGET_HOST:443:$ORIGIN_IP" \
    --max-time 10 \
    "$TARGET_URL" 2>&1 || true)

echo "$DIRECT_RESULT" > "$OUT/direct_connection_test.txt"

# Check for various SSL failure indicators
if echo "$DIRECT_RESULT" | grep -qiE "(SSL_ERROR|ssl.*error|alert|handshake.*fail|certificate.*required|tlsv1.*alert|Connection refused)"; then
    echo "[OK] Direct connection REJECTED (SSL/TLS error)"
    echo "     mTLS (Authenticated Origin Pull) is working correctly!"
    echo ""
    echo "     Error details:"
    echo "$DIRECT_RESULT" | grep -iE "(SSL|alert|handshake|certificate)" | head -5 | sed 's/^/     /'
    add_test_result "mtls_origin_protection" "pass" "ok" "Direct connections rejected with SSL error"

elif echo "$DIRECT_RESULT" | grep -qiE "(HTTP/[12]|200 OK|30[0-9]|40[0-9]|50[0-9])"; then
    echo "[CRITICAL] Direct connection SUCCEEDED!"
    echo "           Origin is accessible without going through Cloudflare!"
    echo "           mTLS (Authenticated Origin Pull) is NOT working."
    echo ""
    echo "           This is a security vulnerability:"
    echo "           - Attackers can bypass Cloudflare DDoS protection"
    echo "           - Origin IP is exposed and directly reachable"
    echo ""
    echo "           Fix: Enable Authenticated Origin Pull in Cloudflare and"
    echo "           configure Caddy to require client certificates."
    add_test_result "mtls_origin_protection" "fail" "critical" "Direct connection succeeded - mTLS not working"
else
    echo "[WARN] Unclear result - manual verification needed"
    echo "       Response:"
    echo "$DIRECT_RESULT" | head -10 | sed 's/^/       /'
    add_test_result "mtls_origin_protection" "warn" "medium" "Unclear result - manual review needed"
fi

echo ""
echo "=== Test 5.3: Verify connection via Cloudflare works ==="
echo ""

CF_RESULT=$(docker run --rm curlimages/curl -sS -o /dev/null -w "%{http_code}" \
    --max-time 15 \
    "$TARGET_URL" 2>/dev/null || echo "000")

echo "HTTP Status via Cloudflare: $CF_RESULT"

if [[ "$CF_RESULT" == "200" ]]; then
    echo "[OK] Connection via Cloudflare works (HTTP 200)"
    add_test_result "cloudflare_connection" "pass" "ok" "HTTP 200 via Cloudflare"
elif [[ "$CF_RESULT" == "520" ]]; then
    echo "[WARN] HTTP 520 - Cloudflare cannot reach origin"
    echo "       This might indicate mTLS misconfiguration."
    add_test_result "cloudflare_connection" "fail" "high" "HTTP 520 - origin unreachable"
elif [[ "$CF_RESULT" == "521" ]]; then
    echo "[FAIL] HTTP 521 - Origin server is down"
    add_test_result "cloudflare_connection" "fail" "high" "HTTP 521 - origin down"
elif [[ "$CF_RESULT" == "522" ]]; then
    echo "[FAIL] HTTP 522 - Connection timed out"
    add_test_result "cloudflare_connection" "fail" "high" "HTTP 522 - connection timeout"
elif [[ "$CF_RESULT" == "523" ]]; then
    echo "[FAIL] HTTP 523 - Origin unreachable"
    add_test_result "cloudflare_connection" "fail" "high" "HTTP 523 - origin unreachable"
elif [[ "$CF_RESULT" == "525" ]]; then
    echo "[FAIL] HTTP 525 - SSL handshake failed with origin"
    echo "       Check SSL mode (should be 'Full' not 'Flexible')"
    add_test_result "cloudflare_connection" "fail" "high" "HTTP 525 - SSL handshake failed"
elif [[ "$CF_RESULT" == "526" ]]; then
    echo "[FAIL] HTTP 526 - Invalid SSL certificate on origin"
    add_test_result "cloudflare_connection" "fail" "high" "HTTP 526 - invalid origin cert"
elif [[ "$CF_RESULT" =~ ^3 ]]; then
    echo "[OK] Redirect response ($CF_RESULT)"
    add_test_result "cloudflare_connection" "pass" "ok" "Redirect via Cloudflare"
else
    echo "[WARN] Unexpected status: $CF_RESULT"
    add_test_result "cloudflare_connection" "warn" "medium" "Unexpected status: $CF_RESULT"
fi

echo ""
echo "=== Test 5.4: Check Cloudflare SSL Mode (if API token provided) ==="
echo ""

if [[ -n "${CLOUDFLARE_API_TOKEN:-}" ]] && [[ -n "${CLOUDFLARE_ZONE_ID:-}" ]]; then
    echo "Checking Cloudflare SSL settings via API..."

    SSL_MODE=$(docker run --rm curlimages/curl -sS \
        -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN" \
        -H "Content-Type: application/json" \
        "https://api.cloudflare.com/client/v4/zones/$CLOUDFLARE_ZONE_ID/settings/ssl" \
        2>/dev/null | jq -r '.result.value // "unknown"')

    echo "  SSL Mode: $SSL_MODE"

    if [[ "$SSL_MODE" == "full" ]] || [[ "$SSL_MODE" == "strict" ]]; then
        echo "[OK] SSL mode is '$SSL_MODE' (correct for proxy mode)"
        add_test_result "ssl_mode" "pass" "ok" "SSL mode: $SSL_MODE"
    elif [[ "$SSL_MODE" == "flexible" ]]; then
        echo "[HIGH] SSL mode is 'flexible' - origin connection is HTTP!"
        echo "       This means Cloudflare connects to your origin on port 80 unencrypted."
        echo "       Change to 'Full' or 'Full (strict)' in Cloudflare dashboard."
        add_test_result "ssl_mode" "fail" "high" "SSL mode is flexible - insecure"
    elif [[ "$SSL_MODE" == "off" ]]; then
        echo "[CRITICAL] SSL mode is 'off' - no encryption!"
        add_test_result "ssl_mode" "fail" "critical" "SSL mode is off"
    else
        echo "[WARN] Could not determine SSL mode: $SSL_MODE"
        add_test_result "ssl_mode" "warn" "medium" "Unknown SSL mode: $SSL_MODE"
    fi

    echo ""
    echo "Checking Authenticated Origin Pull status..."

    AOP_STATUS=$(docker run --rm curlimages/curl -sS \
        -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN" \
        -H "Content-Type: application/json" \
        "https://api.cloudflare.com/client/v4/zones/$CLOUDFLARE_ZONE_ID/origin_tls_client_auth/settings" \
        2>/dev/null | jq -r '.result.enabled // "unknown"')

    echo "  Authenticated Origin Pull: $AOP_STATUS"

    if [[ "$AOP_STATUS" == "true" ]]; then
        echo "[OK] Authenticated Origin Pull is enabled"
        add_test_result "authenticated_origin_pull" "pass" "ok" "AOP enabled"
    elif [[ "$AOP_STATUS" == "false" ]]; then
        echo "[HIGH] Authenticated Origin Pull is DISABLED!"
        echo "       Enable it in Cloudflare dashboard: SSL/TLS > Origin Server > Authenticated Origin Pulls"
        add_test_result "authenticated_origin_pull" "fail" "high" "AOP disabled"
    else
        echo "[WARN] Could not determine AOP status"
        add_test_result "authenticated_origin_pull" "warn" "medium" "Unknown AOP status"
    fi
else
    echo "[INFO] Skipping API checks (no CLOUDFLARE_API_TOKEN or CLOUDFLARE_ZONE_ID)"
    echo "       Set these in .env to enable automatic configuration checks."
fi

echo ""
echo "=== Test 5.5: DNS Proxy Status Check ==="
echo ""

# Check if DNS is using Cloudflare proxy (should NOT resolve to origin IP)
RESOLVED_IP=$(docker run --rm nicolaka/netshoot dig +short "$TARGET_HOST" | head -1)
echo "Resolved IP: $RESOLVED_IP"

if [[ "$RESOLVED_IP" == "$ORIGIN_IP" ]]; then
    echo "[CRITICAL] DNS resolves to origin IP!"
    echo "           Cloudflare proxy (orange cloud) is NOT active."
    echo "           Enable proxy in Cloudflare DNS dashboard."
    add_test_result "dns_proxy_mode" "fail" "critical" "DNS resolves to origin - proxy disabled"
else
    # Check if IP belongs to Cloudflare ranges
    # Cloudflare publishes their IP ranges: https://www.cloudflare.com/ips/
    echo "[OK] DNS does not resolve to origin IP"
    echo "     IP $RESOLVED_IP (should be a Cloudflare IP)"
    add_test_result "dns_proxy_mode" "pass" "ok" "DNS resolves to Cloudflare IP"
fi

echo ""
echo "=============================================="
echo "Cloudflare Proxy Mode Tests Complete"
echo "=============================================="
echo "Results saved to: $OUT/cloudflare_proxy_findings.json"
echo ""

# Summary
CRITICAL=$(jq '[.tests[] | select(.severity == "critical")] | length' "$OUT/cloudflare_proxy_findings.json")
HIGH=$(jq '[.tests[] | select(.severity == "high")] | length' "$OUT/cloudflare_proxy_findings.json")
PASS=$(jq '[.tests[] | select(.status == "pass")] | length' "$OUT/cloudflare_proxy_findings.json")
TOTAL=$(jq '.tests | length' "$OUT/cloudflare_proxy_findings.json")

echo "Summary: $PASS/$TOTAL tests passed"
if [[ "$CRITICAL" -gt 0 ]]; then
    echo "         $CRITICAL CRITICAL issues found!"
fi
if [[ "$HIGH" -gt 0 ]]; then
    echo "         $HIGH HIGH severity issues found!"
fi
