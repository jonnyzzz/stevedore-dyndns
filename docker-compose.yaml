services:
  dyndns:
    build: .
    image: stevedore-dyndns:latest
    container_name: stevedore-dyndns
    restart: unless-stopped
    ports:
      - "80:80"       # HTTP (redirect to HTTPS)
      - "443:443"     # HTTPS
      - "443:443/udp" # HTTP/3 (QUIC)
      # Health endpoint only on localhost for security
      - "127.0.0.1:8080:8080"
    environment:
      # Required - set via stevedore param or .env
      - CLOUDFLARE_API_TOKEN=${CLOUDFLARE_API_TOKEN}
      - CLOUDFLARE_ZONE_ID=${CLOUDFLARE_ZONE_ID}
      - DOMAIN=${DOMAIN}
      - ACME_EMAIL=${ACME_EMAIL}
      # Optional - Fritzbox configuration
      - FRITZBOX_HOST=${FRITZBOX_HOST:-192.168.178.1}
      - FRITZBOX_USER=${FRITZBOX_USER:-}
      - FRITZBOX_PASSWORD=${FRITZBOX_PASSWORD:-}
      # Optional - Manual IP override (disables auto-detection)
      - MANUAL_IPV4=${MANUAL_IPV4:-}
      - MANUAL_IPV6=${MANUAL_IPV6:-}
      # Optional - Tuning
      - IP_CHECK_INTERVAL=${IP_CHECK_INTERVAL:-5m}
      - LOG_LEVEL=${LOG_LEVEL:-info}
      # Stevedore integration
      - STEVEDORE_DATA=${STEVEDORE_DATA:-/data}
      - STEVEDORE_LOGS=${STEVEDORE_LOGS:-/var/log/dyndns}
    volumes:
      # Persistent data (certificates, state)
      - ${STEVEDORE_DATA:-./data}:/data
      # Logs
      - ${STEVEDORE_LOGS:-./logs}:/var/log/dyndns
      # Mapping configuration
      - ${STEVEDORE_DATA:-./data}/mappings.yaml:/data/mappings.yaml:ro
      # NOTE: Docker socket NOT mounted by default for security
      # Uncomment if you need container discovery (v2 feature):
      # - /var/run/docker.sock:/var/run/docker.sock:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    # Security hardening
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE  # Required for binding to ports 80/443
    # Use host network for Fritzbox TR-064/UPnP discovery
    # If you don't need auto IP detection, use bridge mode instead
    network_mode: host
    # NOTE: When using network_mode: host, the 'ports' section is ignored
    # and all container ports are directly exposed on the host.
    # For production, consider bridge mode with manual IP configuration:
    #
    # Alternative bridge mode configuration:
    # network_mode: bridge
    # networks:
    #   - stevedore

# Uncomment for bridge mode deployment
# networks:
#   stevedore:
#     external: true
#     name: stevedore
