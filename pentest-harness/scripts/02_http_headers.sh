#!/bin/bash
# Test 2: HTTP Headers and Security Headers Analysis
set -euo pipefail

OUT="${1:?Usage: $0 <output_dir>}"
source "$(dirname "$0")/../.env"

echo "[2.1] Fetching HTTP headers..."
docker run --rm curlimages/curl -sS -D - -o /dev/null "$TARGET_URL" | tee "$OUT/http_headers.txt"

echo ""
echo "[2.2] Analyzing security headers..."

HEADERS=$(cat "$OUT/http_headers.txt")

# Initialize findings file
cat > "$OUT/header_findings.json" << 'EOF'
{"findings": []}
EOF

check_header() {
    local header="$1"
    local severity="$2"
    local desc="$3"
    local sev_upper
    sev_upper=$(echo "$severity" | tr '[:lower:]' '[:upper:]')

    if echo "$HEADERS" | grep -qi "^$header:"; then
        echo "  [OK] $header present"
        return 0
    else
        echo "  [$sev_upper] $header MISSING - $desc"
        local tmp=$(mktemp)
        jq --arg h "$header" --arg s "$severity" --arg d "$desc" \
           '.findings += [{"header": $h, "severity": $s, "description": $d}]' \
           "$OUT/header_findings.json" > "$tmp" && mv "$tmp" "$OUT/header_findings.json"
        return 1
    fi
}

echo ""
echo "Security headers check:"

# Critical headers
check_header "Strict-Transport-Security" "high" "HSTS not enabled - vulnerable to protocol downgrade attacks" || true
check_header "X-Content-Type-Options" "medium" "Missing nosniff - vulnerable to MIME type sniffing" || true
check_header "X-Frame-Options" "medium" "Missing clickjacking protection" || true

# Important headers
check_header "Content-Security-Policy" "low" "No CSP - limited XSS protection" || true
check_header "X-XSS-Protection" "info" "Legacy XSS protection header (deprecated but still useful)" || true
check_header "Referrer-Policy" "low" "No referrer policy set" || true
check_header "Permissions-Policy" "info" "No permissions policy (formerly Feature-Policy)" || true

echo ""
echo "[2.3] Checking for information disclosure..."

# Check Server header
if echo "$HEADERS" | grep -qi "^server:"; then
    SERVER=$(echo "$HEADERS" | grep -i "^server:" | head -1)
    echo "  [INFO] Server header exposed: $SERVER"
    # Check if overly verbose
    if echo "$SERVER" | grep -qiE "(version|[0-9]+\.[0-9]+)"; then
        echo "  [WARN] Server header reveals version information"
    fi
fi

# Check for other information leakage headers
for header in "X-Powered-By" "X-AspNet-Version" "X-AspNetMvc-Version"; do
    if echo "$HEADERS" | grep -qi "^$header:"; then
        VALUE=$(echo "$HEADERS" | grep -i "^$header:" | head -1)
        echo "  [WARN] Information disclosure: $VALUE"
    fi
done

echo ""
echo "[2.4] Cookie security check..."
if echo "$HEADERS" | grep -qi "^set-cookie:"; then
    echo "  Cookies found, checking flags..."

    while IFS= read -r cookie; do
        echo "  Cookie: $cookie"

        if ! echo "$cookie" | grep -qi "secure"; then
            echo "    [HIGH] Missing Secure flag"
        fi
        if ! echo "$cookie" | grep -qi "httponly"; then
            echo "    [MEDIUM] Missing HttpOnly flag"
        fi
        if ! echo "$cookie" | grep -qi "samesite"; then
            echo "    [LOW] Missing SameSite flag"
        fi
    done < <(echo "$HEADERS" | grep -i "^set-cookie:")
else
    echo "  No cookies set"
fi

echo ""
echo "Header analysis complete. Results saved to $OUT/header_findings.json"
