#!/usr/bin/env bash
# Test 7: Nuclei Template-based Vulnerability Checks
set -euo pipefail

OUT="${1:?Usage: $0 <output_dir>}"
source "$(dirname "$0")/../.env"

RATE_LIMIT="${RATE_LIMIT:-5}"

echo "[7.1] Running Nuclei vulnerability scanner..."
echo "      Rate limit: $RATE_LIMIT req/s"
echo "      Checking for high/critical severity issues only"
echo ""

docker run --rm -v "$OUT:/data" projectdiscovery/nuclei \
    -u "$TARGET_URL" \
    -severity high,critical \
    -rl "$RATE_LIMIT" \
    -jsonl -o /data/nuclei.jsonl \
    2>&1 | tee "$OUT/nuclei_output.txt" || true

echo ""
echo "[7.2] Analyzing Nuclei results..."

if [[ -f "$OUT/nuclei.jsonl" ]] && [[ -s "$OUT/nuclei.jsonl" ]]; then
    FINDING_COUNT=$(wc -l < "$OUT/nuclei.jsonl")
    echo "  Found $FINDING_COUNT potential issue(s)"

    echo ""
    echo "  Findings:"
    while IFS= read -r line; do
        NAME=$(echo "$line" | jq -r '.info.name // "Unknown"')
        SEV=$(echo "$line" | jq -r '.info.severity // "unknown"')
        MATCHED=$(echo "$line" | jq -r '.matched-at // ""')
        echo "    [$SEV] $NAME"
        echo "           $MATCHED"
    done < "$OUT/nuclei.jsonl"

    if [[ "$FINDING_COUNT" -gt 0 ]]; then
        echo ""
        echo "  [WARN] Review findings carefully - Nuclei can have false positives"
    fi
else
    echo "  [OK] No high/critical vulnerabilities detected by Nuclei"
fi

echo ""
echo "Nuclei scan complete."
